# Renew LetsEncrypt SSL Certificate for a GitLab Pages blog with Custom Domain

## Problem

[My site](https://amreldib.com) is hosted as a Jekyll static site on GitLab pages which allows for custom domains and SSL certificates generated by LetsEncrypt.  
The problem is that LetsEncrypt certificates only last for 3 months, so they require renewal, otherwise users will get errors when visiting the site.  

## Solution 

To install a certificate for the first time, use this [guide from GitLab](https://about.gitlab.com/2016/04/11/tutorial-securing-your-gitlab-pages-with-tls-and-letsencrypt/).  
More info about [LetsEncrypt certbot manual mode](https://certbot.eff.org/docs/using.html#manual). 

To install LetsEncrypt client on Fedora, use:  
`sudo dnf certbot`  

To get help on how to use certbot, use:  
`certbot --help`  

[Where are all certificates saved](https://certbot.eff.org/docs/using.html#where-are-my-certificates)  

List existing certificates:  
`sudo certbot certificates`  
You should see existing certificates.  

Renewing certificates that were created using manual mode is not supported. The `renew` command is only available for automation (read [this thread](https://community.letsencrypt.org/t/certbot-manual-renew/17789/2)).  
To renew a certificate created using manual mode, you have to create a new certificate in the same way.  

To create a new certificate:  
- VERY IMPORTANT: Don't just press ENTER at every prompt before carefull reading what it says. One prompt will require waiting and making changes to web site before pressing ENTER.  
- `sudo certbot certonly -a manual -d amreldib.com`  
- When asked if you're OK with your IP being logged, type `y`.  
- You'll be asked to make sure that your web server displays certain content at a certain URL that looks like this:  
`http://amreldib.com/.well-known/acme-challenge/<some long ID>`  
- DO NOT PRESS ENTER. Wait till creating this file.  
- Copy the content and then add it to the blog at that URL.  
- Use the file `letsencrypt-setup.html` at the root of the project to add the content provided by `certbot`.  
    - Make sure to update the correct URL and value in the file.  
- Commit and upload changes and wait for Gitlab pipelines to update the blog.  
- In a browser, check that the proof URL works correctly.  
- If it does, go to the terminal and press ENTER.  
- You should see that certificate and chain is generated and is saved at `/etc/letsencrypt/live/amreldib.com/fullchain.pem` and the expiry date.  
- In the terminal, copy the newly modified files `fullchain.pem` and `privkey.pem` to the Downloads folder (for example) to easily copy their content to the browser.  
- You'll use `sudo`.  
- You might notice that the certificate is just appended to existing certificate.  
- Browse to gitlab, and go to Pages > Domains section in the project's settings.  
- Remove the existing domain (I know, it's weird).  
- Add the same domain again `amreldib.com` along with the the full chain and private key.  
- Wait for the date when the certificate begins to test it.  
